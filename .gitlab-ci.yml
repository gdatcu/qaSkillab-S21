# Imaginea Docker oficială Maven cu Java 21
image: maven:3.9.6-eclipse-temurin-21

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"

cache:
  paths:
    - .m2/repository

stages:
  - test
  - report

# JOB 1: Testare
run_tests:
  stage: test
  tags:
    - qagitlab  # Tag-ul runner-ului tău
  script:
    - echo "Rulare teste HapifyMe cu Java 21..."
    - java -version

    # --- CHEIA SUCCESULUI: ignore failure ---
    # Această comandă rulează testele DAR nu oprește scriptul dacă ele pică.
    # Astfel, ajungem la pasul de generare a artefactelor.
    - mvn clean test -Dmaven.test.failure.ignore=true

    # --- DEBUGGING ---
    - echo "=== DEBUG: Verificare folder allure-results ==="
    - ls -la target/allure-results || echo "AVERTISMENT: Folderul target/allure-results NU există!"

  # Salvăm rezultatele pentru următorul job
  artifacts:
    when: always
    paths:
      - target/allure-results/
      - logs/
    expire_in: 1 day

# JOB 2: Raportare (Pages)
pages:
  stage: report
  tags:
    - qagitlab
  script:
    # --- DEBUGGING ---
    - echo "=== DEBUG: Verificare artefacte primite de la run_tests ==="
    - ls -la target/allure-results || echo "EROARE: Artefactele nu au ajuns în acest job!"

    - mkdir public
    # Instalare Allure manual (imaginea maven nu il are)
    - apt-get update && apt-get install -y wget unzip
    - wget https://github.com/allure-framework/allure2/releases/download/2.24.0/allure-2.24.0.zip
    - unzip allure-2.24.0.zip -d /opt/
    - /opt/allure-2.24.0/bin/allure generate target/allure-results -o public
  artifacts:
    paths:
      - public
  only:
    - main
